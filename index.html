<html>

<head>
<script src="code/basics/LLA.js"></script>
<script src="code/basics/jq.js"></script>
<script src="code/basics/LCanvas.js"></script>
<script src="code/basics/Liso.js"></script>
</head>

<body style="padding:0px;margin:0px;">
<div id="output"></div>
<canvas id="myCanvas" width="960" height="540"></canvas>
<script>

/*
todo:
	setup map object:
		outliers for the map
		setup 
		setup a panning system


*/

var focus = new LV3(0, 0, 0);
function addFocus(){
	var f2 = focus.copy();
	f2.idiv(25);
	f2.floor();
	$('#output').html(focus.toString()
		+ '<br/>'
		+ f2.toString());
}

$(document.body).keydown(function(e){
	//console.log(e);
	var key = e.keyCode;
	console.log(key);
	if(key == 87){
		focus.x += 0.8;
	}else if(key == 83){
		focus.x -= 0.8;
	}else if(key == 65){
		focus.z += 0.8;
	}else if(key == 68){
		focus.z -= 0.8;
	}
});


var count = 0;
var canv = new LCanvas();
function clearScreen(){ canv.setFill('black'); canv.rectf(0, 0, canv.w, canv.h);}
var sqSize = 25;

//going to warp it to iso
var iso33 = Liso.iso33();

var iso44 = Liso.iso44();
var hw = canv.getCenter();

var fsz = [-0, 3];
var fsx = [-0, 1];
	

var mouse = new LV2(0, 0);

function map(){
	
	canv.context.translate(hw.x, hw.y);
	canv.transform(iso33);
	canv.setStroke('orange');
	for(var y = fsz[0]; y < fsz[1]; y++){
		for(var x = fsx[0]; x < fsx[1]; x++){
			canv.rect(x*sqSize, y*sqSize, sqSize, sqSize);
		}
	}
	canv.resetTransform();
}

function map2(){
	canv.setStroke('blue');
	canv.context.translate(hw.x, hw.y);
	
	for(var zi = fsz[0]; zi < fsz[1]; zi++){
		var z = zi*sqSize;
		for(var xj = fsx[0]; xj < fsx[1]; xj++){
			var x = xj*sqSize;
			var pnts = [new LV3(x, 0, z), new LV3(x+sqSize, 0, z),
			new LV3(x+sqSize, 0, z+sqSize), new LV3(x, 0, z+sqSize)];
			for(var i = 0; i < 4; i++){pnts[i] = iso44.multLV3(pnts[i]);}
			for(var i = 0; i < 4; i++){
				var j = (i+1)%4;
				var a = pnts[i];
				var b = pnts[j];
				a.round();
				b.round();
				canv.line(a.x, a.y, b.x, b.y);
			}
		}
	}
	canv.resetTransform();

}

function drawSelection(){
	canv.context.translate(hw.x, hw.y);
	canv.transform(iso33);
	canv.setStroke('green');
	canv.rect(mouse.x*sqSize, mouse.y*sqSize, sqSize, sqSize);
	canv.resetTransform();

}

function draw(){
	var focusLV2 = new LV2(focus.x, focus.z);
	iso33 = Liso.iso33(focusLV2);
	iso44 = Liso.iso44(focus);

	clearScreen();
	map();
	map2();
	drawSelection();
	addFocus();
	requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

function getMousePos(canvas, evt) {
	var rect = canvas.getBoundingClientRect();
	return {
		x: evt.clientX - rect.left,
		y: evt.clientY - rect.top
	};
}

canv.canvas.addEventListener('mousemove', function(evt) {
        var mousePos = getMousePos(canv.canvas, evt);
        var p = new LV2(mousePos.x, mousePos.y);
        p.isub(hw);
        var tmp = new LV2(-focus.x, -focus.z);
        //p.isub(tmp);
        p = Liso.screen2Tile(p);
        //console.log(p.toString());
		p.isub(tmp);
		//console.log(p.toString());
        p.idiv(sqSize);

        p.floor();
        console.log(p.toString());
        mouse = p;
      }, false);

$(canv.canvas).click(function(){
	//$('#output').html(mouse.toString());
});

</script>
</body>

</html>